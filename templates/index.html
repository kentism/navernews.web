<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCSC ë„¤ì´ë²„ ë‰´ìŠ¤ í´ë¦¬í•‘</title>
    <!-- favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ“°</text></svg>">
    <style>
        html {
            overflow-y: scroll;  /* í•­ìƒ ìŠ¤í¬ë¡¤ë°” ê³µê°„ ì˜ˆì•½ */
        }
        
        body {
            margin: 0;
            padding: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        /* ê²€ìƒ‰ í¼ */
        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .search-box button {
            padding: 12px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-box button:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: #fafafa;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: color 0.3s ease;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
        }

        .tab-btn.active::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • */
        #resultTabs .tab-btn {
            padding: 8px 12px; /* ì„¸ë¡œ, ê°€ë¡œ íŒ¨ë”© ì¶•ì†Œ */
            font-size: 14px;   /* í°íŠ¸ í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            flex: 0 1 auto;    /* íƒ­ ë„ˆë¹„ë¥¼ ë‚´ìš©ì— ë§ê²Œ ì¡°ì ˆ */
            border-radius: 6px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¶”ê°€ */
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tabs-content {
            flex: 1;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
            height: 100%; /* ë¶€ëª¨(.tabs-content)ì˜ ë†’ì´ë¥¼ ì±„ìš°ë„ë¡ ì„¤ì • */
        }

        .tab-pane.active {
            display: flex; /* flexbox ë ˆì´ì•„ì›ƒ í™œì„±í™” */
            flex-direction: column; /* ìì‹ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        }

        /* í´ë¦¬í•‘ íƒ­ì´ í™œì„±í™”ë˜ë©´, ë¶€ëª¨(.tabs-content)ì˜ ìŠ¤í¬ë¡¤ì„ ë¹„í™œì„±í™”í•˜ê³  ìì²´ì ìœ¼ë¡œ ë ˆì´ì•„ì›ƒì„ ê´€ë¦¬í•©ë‹ˆë‹¤. */
        .tab-pane.active#clippings {
            overflow-y: hidden; /* ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤ì„ ê´€ë¦¬í•˜ë¯€ë¡œ ë¶€ëª¨ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }


        /* í´ë¦¬í•‘ íƒ­ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ */
        .clipping-text-section {
            flex: 1; /* ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ì„±ì¥ */
            display: flex;
            flex-direction: column;
            flex-direction: column; /* ë‚´ë¶€ ìš”ì†Œë¥¼ ì„¸ë¡œë¡œ ë°°ì¹˜ */
            min-height: 400px; /* í…ìŠ¤íŠ¸ ì˜ì—­ ì„¹ì…˜ì˜ ìµœì†Œ ë†’ì´ */
        }

        .clipping-text-section textarea {
            flex: 1; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê³µê°„ì„ ì±„ìš°ë„ë¡ ì„±ì¥ */
        }

        .clipping-list-section {
            flex-shrink: 0; /* ëª©ë¡ì´ ê¸¸ì–´ì ¸ë„ ì˜ì—­ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
            flex-basis: 30%; /* í´ë¦¬í•‘ ëª©ë¡ ì˜ì—­ì˜ ê¸°ë³¸ ë†’ì´ë¥¼ íƒ­ì˜ 40%ë¡œ ì„¤ì • */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
            padding: 12px; /* ìƒë‹¨ í…ìŠ¤íŠ¸ ì„¹ì…˜ê³¼ ì¼ê´€ëœ íŒ¨ë”© */
        }

        /* ê²€ìƒ‰ ê²°ê³¼ íƒ­ */
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .news-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .news-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .news-content {
            flex: 1;
            margin-right: 15px;
        }

        .news-item h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.4;
        }

        .news-item p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-actions {
            display: flex;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none; /* ë§í¬ ë°‘ì¤„ ì œê±° */
            color: #333; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì§€ì • */
            background-color: #f0f0f0; /* ê¸°ë³¸ ë°°ê²½ìƒ‰ ì§€ì • */
        }

        /* íƒ­ ì½˜í…ì¸  ë‚´ë¶€ íŒ¨ë”©ìš© */
        .tab-content-inner {
            padding: 20px;
        }

        .btn-detail {
            background: #667eea;
            color: white;
        }

        .btn-detail:hover {
            background: #5568d3;
        }

        .btn-clip {
            background: #f0f0f0;
            color: #333;
        }

        .btn-clip:hover {
            background: #e0e0e0;
        }

        .btn-clip.clipped {
            background: #ffd700;
            color: #333;
        }

        /* í´ë¦¬í•‘ íƒ­ */
        .clips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 300px; /* í´ë¦¬í•‘ ì¹´ë“œ ëª©ë¡ì˜ ìµœëŒ€ ë†’ì´ ì œí•œ */
            overflow-y: auto; /* ë‚´ìš©ì´ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ ìƒì„± */
        }

        .clip-card {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clip-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #ffd700;
        }

        .clip-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .clip-card p {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .clip-card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-view {
            flex: 1;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-delete {
            padding: 8px 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
            color: #333;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            color: #555;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œë” */
        .infinite-scroll-loader {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            transform: translateY(20px);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” (ê²€ìƒ‰í¼) -->
        <div class="header">
            <h1>ğŸ“° KCSC ë„¤ì´ë²„ ë‰´ìŠ¤ í´ë¦¬í•‘</h1>
            <div class="search-box">
                <input 
                    type="text" 
                    id="keyword" 
                    placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                >
                <button id="searchBtn">ê²€ìƒ‰</button>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜: ê²€ìƒ‰ + í´ë¦¬í•‘ ìœ ì§€ -->
        <div class="tabs-nav">
            <button data-tab="search" class="tab-btn active">ğŸ” ê²€ìƒ‰</button>
            <button data-tab="clippings" class="tab-btn" id="clippingsBtn">ğŸ“Œ í´ë¦¬í•‘</button>
        </div>

        <!-- ìƒë‹¨: ê²°ê³¼ íƒ­(ì˜êµ¬) -->
        <div id="persistentResultArea" style="padding:12px; border-bottom:1px solid #eee; background:#fafafa;">
            <div id="resultTabs" style="display:flex; gap:8px; overflow:auto;"></div>
            <div id="resultContent" style="margin-top:12px;"></div>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tabs-content">
            <!-- ê²€ìƒ‰ íƒ­ -->
            <div id="search" class="tab-pane active">
                <div class="tab-content-inner">
                    <div class="empty-state">
                        <h3>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ë‰´ìŠ¤ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</h3>
                        <p>ìµœì‹  ë‰´ìŠ¤ë¶€í„° í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- í´ë¦¬í•‘ íƒ­ -->
            <div id="clippings" class="tab-pane">
                <div class="tab-content-inner">
                    <!-- í´ë¦¬í•‘ íƒ­ ì½˜í…ì¸ ëŠ” loadClippingsTab()ì— ì˜í•´ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                    <p>í´ë¦¬í•‘ íƒ­ì„ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="clipFromModal()">ğŸ“Œ í´ë¦¬í•‘</button>
                <button class="btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
    // localStorage í‚¤
    const CLIPS_STORAGE_KEY = 'navernews_clips';

    // localStorageì—ì„œ í´ë¦½ ë¡œë“œ
    function getClipsFromStorage(){
        const data = localStorage.getItem(CLIPS_STORAGE_KEY);
        return data ? JSON.parse(data) : {};
    }

    // localStorageì— í´ë¦½ ì €ì¥
    function saveClipsToStorage(clips){
        localStorage.setItem(CLIPS_STORAGE_KEY, JSON.stringify(clips));
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    let searchTabCounter = 0;
    const panelObservers = new Map();
    const defaultClippedText = 'â–  ìœ„ì›íšŒ ê´€ë ¨\n\nâ–  ë°©ì†¡Â·í†µì‹  ê´€ë ¨\n\nâ–  ìœ ê´€ê¸°ê´€ ê´€ë ¨\n\nâ–  ê¸°íƒ€ ê´€ë ¨\n\n';
    let clippedTextContent = defaultClippedText; // í´ë¦¬í•‘ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

    // í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
    function showToast(message) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.remove();
        }, 3000); // 3ì´ˆ í›„ ì‚¬ë¼ì§
    }
    window.showToast = showToast; // ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì „ì—­í™”

    function createSearchTab(keyword, htmlContent, start = 1){
        const id = 'search-' + (++searchTabCounter) + '-' + Date.now().toString(36);
        // ë²„íŠ¼
        const btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.dataset.tab = id;
        btn.textContent = keyword.length>20 ? keyword.slice(0,17)+'â€¦' : keyword;
        btn.onclick = ()=> switchTab(id);
        const close = document.createElement('span'); close.textContent=' Ã—'; close.style.marginLeft='8px';
        close.onclick = (e)=>{ e.stopPropagation(); removeSearchTab(id); };
        btn.appendChild(close);
        document.getElementById('resultTabs').appendChild(btn);

        // íŒ¨ë„
        const panel = document.createElement('div');
        panel.className = 'tab-panel';
        panel.id = id;
        panel.dataset.keyword = keyword;
        panel.dataset.start = String(start);
        panel.innerHTML = `<div class="search-panel-content">${htmlContent}</div>`;
        const sentinel = document.createElement('div');
        sentinel.className = 'panel-sentinel';
        sentinel.textContent = 'ë¡œë”©...';
        panel.appendChild(sentinel);
        document.getElementById('resultContent').appendChild(panel);

        switchTab(id);

        // ë‰´ìŠ¤ ì•„ì´í…œ í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        panel.querySelectorAll('.news-item').forEach(item => {
            item.addEventListener('click', () => {
                showArticleDetail(item.dataset.link, item.dataset.title);
                const clipBtn = modal.querySelector('.btn-primary');
                clipBtn.dataset.source = item.dataset.source;
                clipBtn.dataset.pubdate = item.dataset.pubdate;
                clipBtn.dataset.originallink = item.dataset.origin;
            });
        });

        setupInfiniteScrollForPanel(panel);
        return id;
    }

    function removeSearchTab(id){
        const btn = document.querySelector(`#resultTabs [data-tab="${id}"]`);
        const panel = document.getElementById(id);
        if(btn) btn.remove();
        if(panel){
            if(panelObservers.has(id)){ try{ panelObservers.get(id).disconnect(); }catch(e){} panelObservers.delete(id); }
            panel.remove();
        }
        const remaining = document.getElementById('resultTabs').querySelectorAll('.tab-btn');
        if(remaining.length) switchTab(remaining[remaining.length-1].dataset.tab);
        else {
            document.getElementById('resultContent').style.display = 'none';
            switchTab('search'); // ë©”ì¸ ê²€ìƒ‰ íƒ­ìœ¼ë¡œ ì „í™˜
        }
    }

    function switchTab(tabId){
        if(!tabId) return;

        // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('.tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('#resultTabs .tab-btn').forEach(b => b.classList.remove('active'));

        // ëª¨ë“  ë©”ì¸ íŒ¨ë„(.tab-pane)ê³¼ ê²€ìƒ‰ ê²°ê³¼ íŒ¨ë„(.tab-panel) ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('#resultContent .tab-panel').forEach(p => p.style.display = 'none');

        const mainTabBtn = document.querySelector(`.tabs-nav [data-tab="${tabId}"]`);
        const resultTabBtn = document.querySelector(`#resultTabs [data-tab="${tabId}"]`);
        const panel = document.getElementById(tabId);

        if (mainTabBtn) { // 'search' ë˜ëŠ” 'clippings' íƒ­
            mainTabBtn.classList.add('active');
            if(panel) panel.classList.add('active');
            document.getElementById('resultContent').style.display = 'none';
        } else {
            if(resultTabBtn) resultTabBtn.classList.add('active');
            if(panel) panel.style.display = 'block';
            document.getElementById('resultContent').style.display = 'block';
        }

        // 4) resultTabs ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('#resultTabs .tab-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`#resultTabs [data-tab="${tabId}"]`);
        if (btn) btn.classList.add('active');
    }

    function setupInfiniteScrollForPanel(panel){
        const sentinel = panel.querySelector('.panel-sentinel');
        if(!sentinel) return;
        
        if(panelObservers.has(panel.id)){ 
            try{ panelObservers.get(panel.id).disconnect(); }catch(e){} 
            panelObservers.delete(panel.id); 
        }
        
        let loading = false;
        const observer = new IntersectionObserver(async (entries)=>{
            for(const entry of entries){
                if(!entry.isIntersecting) continue;
                if(loading) return;
                
                loading = true;
                console.log('[INFINITE] Sentinel reached for', panel.id);
                
                const keyword = panel.dataset.keyword;
                let start = parseInt(panel.dataset.start || '1', 10);
                
                console.log('[INFINITE] Loading keyword:', keyword, 'start:', start);
                
                const fd = new FormData(); 
                fd.append('keyword', keyword); 
                fd.append('start', start);
                
                try{
                    const resp = await fetch('/search-results', { method: 'POST', body: fd });
                    console.log('[INFINITE] Response status:', resp.status);
                    
                    if(!resp.ok){ 
                        console.error('[INFINITE] Load failed', resp.status);
                        sentinel.textContent = 'ì¶”ê°€ ë¡œë“œ ì‹¤íŒ¨ (ìƒíƒœ: ' + resp.status + ')';
                        observer.disconnect(); 
                        panelObservers.delete(panel.id); 
                        loading = false; 
                        return; 
                    }
                    
                    const html = await resp.text();
                    console.log('[INFINITE] Loaded HTML length:', html.length);
                    
                    if(!html || html.trim().length === 0){
                        console.log('[INFINITE] No more results');
                        sentinel.textContent = 'ë” ì´ìƒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
                        observer.disconnect();
                        panelObservers.delete(panel.id);
                        loading = false;
                        return;
                    }
                    
                    // sentinel ì•ì— ì½˜í…ì¸  ì‚½ì…
                    sentinel.insertAdjacentHTML('beforebegin', html);
                    
                    // start ì—…ë°ì´íŠ¸
                    panel.dataset.start = String(start + 20);
                    console.log('[INFINITE] Updated start to:', start + 20);
                    
                    loading = false;
                    
                }catch(err){
                    console.error('[INFINITE] Error:', err);
                    sentinel.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                    observer.disconnect();
                    panelObservers.delete(panel.id);
                    loading = false;
                }
            }
        }, { 
            root: null,  // viewport ê¸°ì¤€
            rootMargin: '200px'  // 200px ì „ì— ë¯¸ë¦¬ ê°ì§€
        });
        
        observer.observe(sentinel);
        panelObservers.set(panel.id, observer);
        console.log('[INFINITE] Observer setup for', panel.id);
    }

    async function handleSearch(){
        const kw = document.getElementById('keyword').value.trim();
        if(!kw){ alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
        const fd = new FormData(); fd.append('keyword', kw); fd.append('start', 1);
        try{
            const resp = await fetch('/search-results', { method: 'POST', body: fd });
            if(!resp.ok){ showToast('ê²€ìƒ‰ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜'); return; }
            const html = await resp.text();
            createSearchTab(kw, html, 21); // ë‹¤ìŒ ì‹œì‘ì€ 21 (1~20ì€ ì´ë¯¸ ë¡œë“œë¨)
        }catch(e){
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜', e);
            showToast('ê²€ìƒ‰ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
        }
    }
    window.handleSearch = handleSearch; // ê¸°ì¡´ ì½”ë“œì™€ í˜¸í™˜

    // í´ë¦¬í•‘ íƒ­ ë™ì  ë¡œë“œ
    async function loadClippingsTab(){
        try {
            const resp = await fetch('/clippings-tab');
            const html = await resp.text();
            const clippingsPane = document.getElementById('clippings');
            if(!clippingsPane) return;
            
            // íŒ¨ë”©ì„ ìœ„í•œ ë‚´ë¶€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ê±°ë‚˜ ìƒì„±í•©ë‹ˆë‹¤.
            const innerContainer = clippingsPane.querySelector('.tab-content-inner');

            // 1. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œì™¸í•œ HTMLì„ ë¨¼ì € ì‚½ì…í•©ë‹ˆë‹¤.
            const template = document.createElement('template');
            template.innerHTML = html;
            const scriptEl = template.content.querySelector('script');
            if (scriptEl) { scriptEl.remove(); }
            innerContainer.innerHTML = template.innerHTML;

            // íƒ­ì´ ë¡œë“œëœ í›„, ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ëœ í…ìŠ¤íŠ¸ë¥¼ textareaì— ë³µì›í•©ë‹ˆë‹¤.
            const textArea = document.getElementById('clippingTextArea');
            if (textArea) textArea.value = clippedTextContent;

            // 2. ë¶„ë¦¬í–ˆë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ DOMì— ì¶”ê°€í•˜ì—¬ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
            if (scriptEl) {
                const newScript = document.createElement('script');
                newScript.textContent = scriptEl.textContent; // ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš© ë³µì‚¬
                innerContainer.appendChild(newScript);
            }
        } catch(e) {
            console.error('í´ë¦¬í•‘ ë¡œë“œ ì‹¤íŒ¨', e);
        }
    }

    // í´ë¦¬í•‘ ì‚­ì œ (ì „ì—­ í•¨ìˆ˜ â€” í´ë¦¬í•‘_tab.htmlì˜ ë²„íŠ¼ì—ì„œ í˜¸ì¶œ)
    async function deleteClip(clipId){
        if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const resp = await fetch('/api/clip/' + clipId, { method: 'DELETE' });
            const j = await resp.json();
            if(j.success) {
                showToast('í´ë¦¬í•‘ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadClippingsTab(); // ì¬ë¡œë“œ
            } else {
                showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch(e) {
            console.error(e);
            showToast('ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨');
        }
    }
    window.deleteClip = deleteClip;

    // ëª¨ë“  í´ë¦¬í•‘ ì‚­ì œ
    async function deleteAllClips(){
        if(!confirm('ì •ë§ ëª¨ë“  í´ë¦¬í•‘ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            // UI ì¦‰ì‹œ ë°˜ì˜
            clippedTextContent = defaultClippedText;
            const textArea = document.getElementById('clippingTextArea');
            if (textArea) textArea.value = defaultClippedText;

            const resp = await fetch('/api/clips/all', { method: 'DELETE' });
            const j = await resp.json();
            if(j.success) {
                showToast('ëª¨ë“  í´ë¦¬í•‘ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadClippingsTab();
            }
        } catch(e) {
            console.error(e);
            showToast('ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨');
        }
    }
    window.deleteAllClips = deleteAllClips;

    async function clipArticleFromData(title, url, content, source, pubDate, originalLink, btnEl = null){
        console.log('[CLIP] ì €ì¥ ì‹œë„:', {title, url, content, source, pubDate, originalLink});
        const fd = new FormData();
        fd.append('title', title);
        fd.append('url', url);
        fd.append('content', content || '');
        try {
            const r = await fetch('/api/clip', { method: 'POST', body: fd });
            const j = await r.json();
            console.log('[CLIP] ì‘ë‹µ:', j);
            if (j.success) {
                const date = new Date(pubDate);
                const formattedDate = !isNaN(date) 
                    ? `${date.getFullYear()}. ${date.getMonth() + 1}. ${date.getDate()}`
                    : '';
                const textToAdd = `â–· ${source} : ${title} (${formattedDate})\n${originalLink}\n`;
                
                // 1. ì „ì—­ ë³€ìˆ˜ì— í…ìŠ¤íŠ¸ë¥¼ ëˆ„ì í•©ë‹ˆë‹¤.
                clippedTextContent += textToAdd;
                
                // 2. ë§Œì•½ í´ë¦¬í•‘ íƒ­ì´ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´, textareaì˜ ê°’ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                const textArea = document.getElementById('clippingTextArea');
                if (textArea) textArea.value = clippedTextContent;

                showToast('í´ë¦½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                if (btnEl) {
                    btnEl.textContent = 'âœ“ í´ë¦½ë¨';
                    btnEl.classList.add('clipped');
                    btnEl.disabled = true;
                }

            } else {
                showToast('í´ë¦½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (j.message || ''));
            }
        } catch(e) {
            console.error('[CLIP] ìš”ì²­ ì‹¤íŒ¨:', e);
            showToast('í´ë¦½ ìš”ì²­ ì‹¤íŒ¨');
        }
    }

    window.clipArticleFromEl = function(btnEl){
        const item = (btnEl && btnEl.closest) ? btnEl.closest('.news-item') : null;
        const title = item?.dataset?.title || '';
        const url = item?.dataset?.link || '';
        const content = item?.dataset?.desc || '';
        const source = item?.dataset?.source || item?.dataset?.domain || '';
        const pubDate = item?.dataset?.pubdate || '';
        const originalLink = item?.dataset?.origin || url;
        return clipArticleFromData(title, url, content, source, pubDate, originalLink, btnEl);
    };

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    async function showArticleDetail(url, title) {
        if (!url || !title) return;

        modalTitle.textContent = title;
        modalBody.innerHTML = '<div class="loading">ê¸°ì‚¬ ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        modal.classList.add('active');

        // ëª¨ë‹¬ì˜ í´ë¦¬í•‘ ë²„íŠ¼ì— ë°ì´í„° ì„¤ì •
        const clipBtn = modal.querySelector('.btn-primary');
        clipBtn.dataset.url = url;
        clipBtn.dataset.title = title;
        // news-item í´ë¦­ ë¦¬ìŠ¤ë„ˆì—ì„œ ì´ë¯¸ source, pubdate, originallinkë¥¼ ì„¤ì •í•¨

        const fd = new FormData();
        fd.append('url', url);
        fd.append('title', title);

        const resp = await fetch('/article-detail', { method: 'POST', body: fd });
        modalBody.innerHTML = await resp.text();
        clipBtn.dataset.content = modalBody.textContent.trim().slice(0, 500); // íŒŒì‹±ëœ ë³¸ë¬¸ ì¼ë¶€ ì €ì¥
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    function clipFromModal() {
        const btn = modal.querySelector('.btn-primary');
        clipArticleFromData(
            btn.dataset.title, 
            btn.dataset.url, 
            btn.dataset.content,
            btn.dataset.source,
            btn.dataset.pubdate,
            btn.dataset.originallink,
            btn // ëª¨ë‹¬ì˜ í´ë¦½ ë²„íŠ¼ë„ ìƒíƒœ ë³€ê²½
        );
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        const searchBtn = document.getElementById('searchBtn');
        const input = document.getElementById('keyword');
        if (searchBtn) searchBtn.addEventListener('click', handleSearch);
        if (input) input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });

        const tabsNav = document.querySelector('.tabs-nav');
        if (tabsNav) {
            tabsNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-tab]');
                if (!btn) return;
                const tab = btn.dataset.tab;
                if (tab === 'clippings') {
                    loadClippingsTab(); // í´ë¦¬í•‘ íƒ­ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ë³µì›í•©ë‹ˆë‹¤.
                }
                // ê²€ìƒ‰ ê²°ê³¼ íƒ­ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê¸°ë³¸ ê²€ìƒ‰ íƒ­ìœ¼ë¡œ ëŒì•„ê°€ì§€ ì•ŠìŒ
                if (tab === 'search' && document.querySelector('#resultTabs .tab-btn')) {
                    // ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ë˜ëŠ” ì²«ë²ˆì§¸ ê²€ìƒ‰ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™)
                } else {
                    switchTab(tab);
                }
            });
        }

        // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ê²€ìƒ‰ =====
        async function loadDefaultSearch(){
            const keywords = ['ë°©ì†¡ë¯¸ë””ì–´í†µì‹ ì‹¬ì˜ìœ„ì›íšŒ', 'ë°©ì†¡ë¯¸ë””ì–´í†µì‹ ìœ„ì›íšŒ', 'ê³¼ë°©ìœ„'];
            for (const kw of keywords) {
                const fd = new FormData();
                fd.append('keyword', kw);
                fd.append('start', 1);
                try {
                    const resp = await fetch('/search-results', { method: 'POST', body: fd });
                    if (resp.ok) {
                        const html = await resp.text();
                        createSearchTab(kw, html, 21);
                    }
                } catch(e) {
                    console.error('ê¸°ë³¸ ê²€ìƒ‰ ì˜¤ë¥˜:', e);
                }
            }
        }
        loadDefaultSearch();
    });
    </script>




</body>
</html>